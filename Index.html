<!DOCTYPE html>
<html>
<head>
    <title>DreadHead App</title>
    <meta charset="utf-8" />
	 <meta name="viewport" content="width=device-width, initial-scale=1">
	 <link rel="shortcut icon" href="favicon.ico" type="image/x-icon" /> 
	
    <link rel="stylesheet" href="Assets/css/bootstrap.min.css">	

	
	<script src="https://code.jquery.com/jquery-1.11.2.js"></script>	
	<script src="https://code.jquery.com/ui/1.12.1/jquery-ui.js"></script>
    <link rel="stylesheet" href="https://code.jquery.com/ui/1.12.1/themes/base/jquery-ui.css">
	
	  <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js"></script>

	
	<!-- jquery touch punch (mobile)-->
	<script scrc="Assets/js/jquery.touchpunch.js"></script>

	<!-- rotation stuff -->
	<link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/godswearhats/jquery-ui-rotatable@1.1/jquery.ui.rotatable.css">
	<script src="https://cdn.jsdelivr.net/gh/godswearhats/jquery-ui-rotatable@1.1/jquery.ui.rotatable.min.js"></script>
	
	<!-- <link rel="stylesheet" href="libs/jquery-free-transform-master/css/jquery.freetrans.css"> -->
	<!-- <script src="libs/jquery-free-transform-master/js/Matrix.js"></script> -->
	<!-- <script src="libs/jquery-free-transform-master/js/jquery.freetrans.js"></script> -->
	
	<!--jwatermark-->
	<script src="libs/baivong-watermark-2dd6d88/dist/jquery.watermark.min.js"></script>
	
	<!-- html2canvasK -->
	<script src="libs/html2canvas.js"></script>
	
	<!--bs slider-->
	<script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-slider/10.0.0/bootstrap-slider.min.js"></script>
	<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-slider/10.0.0/css/bootstrap-slider.min.css"  type="text/css">
	
	<!--own style-->
	<link rel="stylesheet" href="Assets/css/site.css" type="text/css">	
<script>

var dreadSelectionArray = ["dario.png","claufrontsmall2.png","clauhigh3.png","dread1.png", "elen4.png"];

var useBlob   = false && window.URL;
function readImage (file) {

	// Create a new FileReader instance
	// https://developer.mozilla.org/en/docs/Web/API/FileReader
	var reader = new FileReader();

	// Once a file is successfully readed:
	reader.addEventListener("load", function () {

		// At this point `reader.result` contains already the Base64 Data-URL
		// and we've could immediately show an image using
		// `elPreview.insertAdjacentHTML("beforeend", "<img src='"+ reader.result +"'>");`
		// But we want to get that image's width and height px values!
		// Since the File Object does not hold the size of an image
		// we need to create a new image and assign it's src, so when
		// the image is loaded we can calculate it's width and height:
		var image  = new Image();
		image.addEventListener("load", function () {
			  
			// Finally append our created image and the HTML info string to our `#preview` 
			$("#userPortrait").append( this );		
			
			 var options = {
			  rotationCenterOffset: {
					top: 0,
					left: 0
				}
			 };
						
			var portraitwidth = $("#userPortrait").width();
			var portraitheight = $("#userPortrait").height();
			
			$("#userPortrait").rotatable(options);
			$("#userPortrait").find("img").resizable()
										
			//adding resizing and dragging
			$("#userPortrait").draggable({ width: portraitwidth, height: portraitheight,
			appendTo:"#cropping-area", scroll: false })
										
			//enable functional buttons
			$('.btn').removeClass("disabled");							

			// If we set the variable `useBlob` to true:
			// (Data-URLs can end up being really large
			// `src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAADAAAAA...........etc`
			// Blobs are usually faster and the image src will hold a shorter blob name
			// src="blob:http%3A//example.com/2a303acf-c34c-4d0a-85d4-2136eef7d723"
			if (useBlob) {
				// Free some memory for optimal performance
				window.URL.revokeObjectURL(image.src);
			}
		});
			
		image.src = useBlob ? window.URL.createObjectURL(file) : reader.result;
  });
  // https://developer.mozilla.org/en-US/docs/Web/API/FileReader/readAsDataURL
  reader.readAsDataURL(file);  
}

/////////////////// Document Ready /////////////////////

$(function () {			
		
		//init DreadSelectionList
		initializeDreadSelectionList(dreadSelectionArray);		
	
		// Instantiate a slider
		$("#imgZoomslider").bootstrapSlider();			
												  
		//Image uploaded event
		$("input:file").change(function () {
		
			 // Let's store the FileList Array into a variable:
			// https://developer.mozilla.org/en-US/docs/Web/API/FileList
			var files  = this.files;
			// Let's create an empty `errors` String to collect eventual errors into:
			var errors = "";

			if (!files) {
				errors += "File upload not supported by your browser.";
			}

			// Check for `files` (FileList) support and if contains at least one file:
			if (files && files[0]) {

				// Iterate over every File object in the FileList array
				for(var i=0; i<files.length; i++) {

					// Let's refer to the current File as a `file` variable
					// https://developer.mozilla.org/en-US/docs/Web/API/File
					var file = files[i];

					// Test the `file.name` for a valid image extension:
					// (pipe `|` delimit more image extensions)
					// The regex can also be expressed like: /\.(png|jpe?g|gif)$/i
					if ( (/\.(png|jpeg|jpg|gif)$/i).test(file.name) ) {
						// SUCCESS! It's an image!
						// Send our image `file` to our `readImage` function!
						readImage( file ); 
					}
					else {
					errors += file.name +" Unsupported Image extension\n";  
					}
				}
			}

			// Notify the user for any errors (i.e: try uploading a .txt file)
			if (errors) {
				alert(errors); 
			}
		});
		
		
		//selecting dreads and add to cropping area
		$(".list-group-item-action").on("click", function(){	
			if(!$(this).hasClass('active'))
			{ 		
				$(".list-group-item-action.active").removeClass("active");
				$(this).addClass("active");
			}				
								
			var dreadImgsrc = $(this).find('img').clone();
			dreadImgsrc.removeClass();
			
			//if already selected, remove dread img
			if($("#userDreads").has('img').length > 0) {
				$("#userDreads").empty();
			}

			//add new dread selection
			$("#userDreads").append(dreadImgsrc);
						
			var dreadwidth = $("#userDreads").width();
			var dreadheight = $("#userDreads").height();
			
			var options = {
			  rotationCenterOffset: {
					top: 0,
					left: 0
				}
			};
						
			//adding img editing options								
			$("#userDreads").rotatable(options);	
			$("#userDreads").find("img").resizable();
//todo activate rotatable after changing dread			

			
			//adding dragging
			$("#userDreads").draggable({ width: dreadwidth, height: dreadheight,
			appendTo: '#cropping-area', scroll:false});	
		
		});					
		
		//render with watermark & download image locally
		$("#dwlBtn").on("click", function(e) {
			e.preventDefault();  //stop the browser from following
			
//todo generate from DIV
//todo do we have a smaller logo for watermarking?
//path: 'http://i.imgur.com/LcpZHu5.png',
			//iniialize / adding watermark
			$('#userPortrait').find("img").watermark({
				path: "http://i.imgur.com/LcpZHu5.png", 
				gravity: 'nw',
				opacity: 1,
				margin: 12,
				outputType: 'png',
				  done: function (imgURL) {						
						$('#outputimage').attr('src', imgURL);							
					}
			});
			
			html2canvas($("#cropping-area"), {
			onrendered: function(canvas) {
				theCanvas = canvas;
				document.body.appendChild(canvas);

				// Convert and download as image 
				Canvas2Image.saveAsPNG(canvas); 
				$("#img-out").append(canvas);
				// Clean up 
				//document.body.removeChild(canvas);
			}
		});
			 
   
		});

		//initialize DreadSelectionList
		function initializeDreadSelectionList(dreadSelectionArray){
			dreadSelectionArray.forEach(function(item, index, array) {
			  $("#dreadSelectionList").append('<a href="#" class="list-group-item list-group-item-action"><img class="dreadCanvasItem" src="Assets/img/dreads/'+item+'"/></a>');
			});			
		};
		
		//share image
		$("#shareBtn").on("click", function (e) {
			e.preventDefault();  //stop the browser from following
			 
		});
		
		//update slider
		$("#imgZoomslider").on("slide", function(slideEvt) {
			//alert(slideEvt.value);					
		});

	//end of doc ready
	});
</script>
</head>

<body>
    <div class="container-fluid">
		
        <div class="col-md">
            <img class="dreadArtLogo"/>
        </div>

        <div class="row">
            <div class="col-md-7">
                <div class="jumbotron">
					<div class="row">
                        <canvas id="croppingArea" class="cropping-area ui-widget-content" orientation="horizontal">
							<div id="userPortrait" class="userPortrait"></div>
							<div id="userDreads" class="userDreads"></div>
                        </canvas>
					</div>
					<input type="text" id="imgZoomslider" data-slider-min="0" data-slider-max="20" data-slider-step="1" data-slider-value="10" />
					<br/><br/>
					<input type="file" class="inputfile" id="myPortraitSelector">
					<label for="myPortraitSelector" class="btn btn-danger">Choose a file</label>
					<br/><br/>
					<button class="btn btn-success disabled" id="dwlBtn">save</button>
					<a href="#shareModal" role="button" class="btn btn-primary disabled" data-toggle="modal" id="shareBtn">share</a>
				</div>
			<!--just for DEV testcases-->
			<div> 
				<img id="outputimage"/>
			</div>
			      	<!-- Modal for sharing-->
<div id="shareModal" class="modal hide fade" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
  <div class="modal-header">
    <button type="button" class="close" data-dismiss="modal" aria-hidden="true">×</button>
    <h3 id="myModalLabel">Modal header</h3>
  </div>
  <div class="modal-body">
    <p>One fine body…</p>
  </div>
  <div class="modal-footer">
    <button class="btn" data-dismiss="modal" aria-hidden="true">Close</button>
    <button class="btn btn-primary">Save changes</button>
  </div>
</div>
			
			<!---->
			</div>
            <div class="col-md-3">
                <form method="post">
                    <div id="dreadSelectionList" class="list-group"/>
                </form>
            </div>
   
		</div>
    </div>
</body>
</html>
